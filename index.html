<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width; initial-scale=1.0">
    <title>Hello wasm-pack!</title>
</head>

<body>
    <canvas id="vote-map" height="256" width="256" style="padding: 0"></canvas>
    <script type="module">
        import init, { render } from './pkg/voting_map.js';

        async function main() {
            await init();
            reloadOnChange();

            const canvas = document.getElementById('vote-map');

            const draw = (quality) => {
                quality = quality || 7;
                const ctx = canvas.getContext('2d');
                try {
                    const candidateCoords = [];
                    for (const [x, y] of candidates) {
                        candidateCoords.push(x);
                        candidateCoords.push(y);
                    }

                    const drawOutlines = false;
                    const drawPoints = false;
                    const data = render(canvas.clientWidth, canvas.clientHeight, candidateCoords, quality, drawOutlines, drawPoints);
                    const image = new ImageData(Uint8ClampedArray.from(data),
                        canvas.clientWidth, canvas.clientHeight);
                    ctx.putImageData(image, 0, 0);
                    for (const [x, y] of candidates) {
                        ctx.beginPath();
                        ctx.arc(x * canvas.clientWidth, y * canvas.clientWidth, 5, 0, 2 * Math.PI);
                        ctx.stroke();
                    }
                } catch (e) {
                    console.error(e);
                }
            }

            let isDrawing = false;
            let selected = null;
            const candidates = [[0.5, 0.99], [0.07, 0.25], [0.93, 0.25]];

            const relativeCoords = ev => {
                const rect = canvas.getBoundingClientRect();
                const x = (ev.clientX - rect.left) / canvas.clientWidth;
                const y = (ev.clientY - rect.top) / canvas.clientHeight;
                return [x, y];
            }

            const selectCandidate = ev => {
                const [x, y] = relativeCoords(ev);

                let minDist = 1;
                for (const cand of candidates) {
                    const [cx, cy] = cand;
                    const dist = Math.sqrt(Math.pow(cx - x, 2) + Math.pow(cy - y, 2));
                    if (dist < minDist && dist < 0.05) {
                        selected = cand;
                        minDist = dist;
                    }
                }
            };

            canvas.addEventListener('mousedown', selectCandidate);
            canvas.addEventListener('touchstart', ev => {
                ev.preventDefault();
                selectCandidate(ev.touches[0]);
            });

            canvas.addEventListener('mouseup', (ev) => {
                selected = null;
                draw();
            });
            document.body.addEventListener('touchend', e => {
                selected = null;
                draw();
            });

            const moveCandidate = ev => {
                if (!selected) return;
                const [x, y] = relativeCoords(ev);
                selected[0] = x;
                selected[1] = y;
                draw(4);
            }

            canvas.addEventListener('mousemove', moveCandidate);
            canvas.addEventListener('touchmove', (ev) => {
                ev.preventDefault();
                moveCandidate(ev.touches[0]);
            });

            draw();
        }

        async function reloadOnChange(createdAt = null) {
            const r = await fetch('./pkg/voting_map_bg.wasm', { method: 'HEAD' });
            const lastModified = r.headers.get("Last-Modified");

            if (createdAt != null && createdAt != lastModified) {
                document.location.reload();
            } else {
                setTimeout(() => reloadOnChange(lastModified), 500);
            }
        }

        main();
    </script>
</body>

</html>